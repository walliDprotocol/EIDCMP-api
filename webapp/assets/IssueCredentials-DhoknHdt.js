import{_ as S,d as U,a as A,l as v,G as D,t as P,v as R,j as W,i as $}from"./index-BsrjhtPE.js";import{ae as M,aa as G,aq as N,Z as T,a3 as n,a8 as f,a9 as r,l as i,a5 as b,X as m,R as _,ad as d,a4 as V,am as F,F as x,n as q,ap as H,A as Z,D as X}from"./vue-BAjJ74_5.js";import{M as z,T as O}from"./MessageModal-C6eklx31.js";import{c as I,at as g,a as C,ap as y,aF as j,B as w,aw as Y,C as J,A as K}from"./vuetify-B6yzhMeP.js";/* empty css                            */import"./icon-close-pH6A5HBf.js";import"./Spinner-Di2pvISG.js";import"./icon-sucessfully-CO2Tb8FD.js";const o=U("IssueCredential"),Q={name:"IssueCredential",title:"pageTitle.issueCredential",components:{MessageModal:z,TemplateCanvas:O},emits:["close"],data(){return{tableValues:[],tableLine:[],tables:[],currentLayout:"",tid:"",attributesMenu:{},step:0,isLoaded:!1,imageLoading:!1,email:null,errorMail:null,reload:!0,sending:!1,templateValuesFront:[],templateValuesBack:[],buttonText:this.$t("button.next"),showSuccessModal:!1,pages:["#page"],emailRules:[t=>!!t||"E-mail is required",t=>/.[^\n\r@\u2028\u2029]*@.+\..+/.test(t)||this.$t("issue.emailError")],issueCredentialWidth:0}},computed:{...M(A,["adminEmail","cid","caName"]),...M(v,["template"]),...G(v,["components","backSide"])},watch:{},beforeDestroy(){o("beforeUnmount() tid: ",this.tid),window.onbeforeunload=null},created(){const t=this.$route.params?.tid;this.tid=t,A()[D]({tid:t}).then(e=>{o("GET_TEMPLATE response",e),this.initialLoad(e)})},mounted(){window.onbeforeunload=function(){return"Are you sure you want to close the window?"}},methods:{...N($,{uploadFile:W}),uploadImage(t,e){o("uploadImage function",t,e),o(this.$refs),this.$refs.uploadImage[e].click()},async newImage(t,e){this.imageLoading=!0,e.value=await this.uploadFile({file:t.target.files[0],folder:`${this.tid}`}).catch(s=>{throw s}),this.imageLoading=!1,this.replaceAttributeImage(e)},async initialLoad(t={}){o("initialLoad",t);const e=t.frontend_props||{},s=t.templateItens||[];if(s.length===0){this.isLoaded=!0;return}v().setTemplate(t),o("this.components: ",this.components),this.createTemplateItems(s),this.backSide=!1,e.backgroundBack&&(!this.pages.includes("#back")&&this.pages.length===1&&this.pages.push("#back"),this.backSide=!0),await this.splitBaseTextIntoArray(this.components),v().setActiveComponent(),await this.$forceUpdate(),o("issueCredentialWidth",this.$refs.formTemplate,this.$refs.formTemplate.offsetWidth,this.$refs.formTemplate.clientWidth,this.$refs.formTemplate.scrollWidth,this.$refs.formTemplate.scrollWidth-this.$refs.formTemplate.clientWidth),this.issueCredentialWidth=this.$refs.formTemplate.clientWidth-300,this.isLoaded=!0},async splitBaseTextIntoArray(t){o("splitBaseTextIntoArray",t),t.forEach(async e=>{e.templateSide==="back"&&(this.pages.length===1&&this.pages.push("#back"),this.backSide=!1),(e.type==="text"||e.type==="image"&&e.dynamicImage)&&(e.baseText=e.text.match(/(\[[A-Z0-9_]+\])|([a-zA-Z0-9!@#$&()\\-`.+,/"]*)/g),e.originalText=e.text.match(/(\[[A-Z0-9_]+\])|([a-zA-Z0-9!@#$&()\\-`.+,/"]*)/g)),e.type==="image"&&(o("components[i]",e),e.src=await this.toDataURL(e.src))}),this.templateValuesFront.forEach(e=>{e.indexArray=this.findAttr(e,t)}),this.templateValuesBack.forEach(e=>{e.indexArray=this.findAttr(e,t)}),this.templateValuesFront.sort(this.compareAttr),this.templateValuesBack.sort(this.compareAttr),o("templateValuesFront",this.templateValuesFront),o("templateValuesBack",this.templateValuesBack)},compareAttr(t,e){return t.attr<e.attr?-1:t.attr>e.attr?1:0},findAttr(t,e){let s,u;return e.some((a,h)=>a.type==="text"&&a.baseText&&a.baseText.length>0||a.type==="image"&&a.dynamicImage?(s=a.baseText.findIndex(k=>k.includes(`[${t.attr}]`)),s>-1?(u=h,!0):!1):!1),{indexComponent:u,indexAttr:s}},replaceAttributeImage(t){o("replaceAttributeImage"),o(t);const e=t.indexArray.indexComponent;this.components[e].src=t.value,this.$forceUpdate()},replaceAttributeText(t){o("replaceAttributeText"),o(t);const e=t.indexArray.indexAttr,s=t.indexArray.indexComponent;o(this.components[s]);const u=this.components[s].baseText;t.value?(u[e]=t.value,o(u)):u[e]=this.components[s].originalText[e],this.components[s].maxCharacters&&(t.maxCharacters=this.components[s].maxCharacters);const a=u.join(" ");this.components[s].text=a,this.$forceUpdate()},createTemplateItems(t){o("createTemplateItems: "),t.forEach(e=>{const s={attr:e.attr,value:null,error:!1,type:e.type,temp_item_id:e._id,isPublic:e.isPublic,isMandatory:e.isMandatory};e.order===0?this.templateValuesFront.push(s):e.order===1&&this.templateValuesBack.push(s)})},async toDataURL(t){return o("toDataURL",t),t?.startsWith("data:image")?t:await new Promise(e=>{const s=new XMLHttpRequest;s.onload=function(){const u=new FileReader;u.onloadend=function(){e(u.result)},u.readAsDataURL(s.response)},s.onerror=function(){e(void 0)},s.open("GET",`${t}?_=${Date.now()}`,!0),s.responseType="blob",s.send()})},clearError(t){this.templateValuesFront[t]&&this.templateValuesFront[t].value?this.templateValuesFront[t].error=!1:this.templateValuesBack[t]&&this.templateValuesBack[t].value?this.templateValuesBack[t].error=!1:this.templateValuesFront[t].error=!0},checkForm(){o("Check form");let t=!1;return this.templateValuesFront.forEach(e=>{(e.isMandatory==="true"||e.isMandatory===!0)&&!e.value||["DATEOFBIRTH","EXPIRYDATE"].includes(e.attr)&&new Date(e.value).toString()==="Invalid Date"?(e.error=!0,t=!0):e.error=!1}),this.templateValuesBack.forEach(e=>{(e.isMandatory==="true"||e.isMandatory===!0)&&!e.value?(e.error=!0,t=!0):e.error=!1}),this.tables&&this.tables.length>0&&this.tableValues.length===0&&(t=!0),t},async createData(){let t=this.templateValuesFront.map(s=>({value:s.value,temp_item_id:s.temp_item_id,isPublic:s.isPublic}));await Promise.all(t).then(s=>{t=s});let e=this.templateValuesBack.map(s=>({value:s.value,temp_item_id:s.temp_item_id,isPublic:s.isPublic}));await Promise.all(e).then(s=>{e=s}),this.data=t.concat(e),this.tables&&this.tables.length>0&&this.tableValues.length>0&&this.data.push({values:this.tableValues,temp_item_id:this.tables[0].item_id,isPublic:!0}),o("Generated Data: ",this.data)},close(){this.$emit("close")},back(){this.step=0,this.buttonText=this.$t("button.next"),this.email=null},async takeTemplateSnapshot(){this.reload=!1,await this.$nextTick(),this.reload=!0,await this.$nextTick();const e=document.getElementById("template-canvas"),s=await P(e);o("takeTemplateSnapshot:imgArray",s);const u=await this.uploadFile({file:s,folder:`${this.cid}`}).catch(a=>{});return o("UPLOAD_FILE:result",u),[u]},async nextStep(){try{switch(this.step){case 0:if(this.checkForm()){this.sending=!1;return}await this.createData(),this.step+=1,this.sending=!1;break;case 1:if(o("Emit cert"),this.sending=!0,this.errorMail=null,!this.email)throw this.errorMail=this.$t("issue.emailError"),new Error("Email is required");await A()[R]({tid:this.tid,data:this.data,email:this.email,imageArray:await this.takeTemplateSnapshot()}),this.showSuccessModal=!0;break;default:break}}catch{this.sending=!1}}}},ee={class:"title_header pr-4"},te={class:"steps"},ae={class:"mb-0 side-header"},se={class:""},le={key:0,style:{color:"#e95e5e"}},re=["onChange"],ie={class:"mb-0 side-header"},oe={class:""},ne={key:0,style:{color:"#e95e5e"}},ue={class:""},pe={style:{position:"absolute",top:"0",left:"0","z-index":"-1",opacity:"0",overflow:"hidden"}};function ce(t,e,s,u,a,h){const k=T("v-stepper-content"),B=T("v-stepper-items"),E=T("TemplateCanvas"),L=T("MessageModal");return n(),f(I,{class:"issue-cred px-0"},{default:r(()=>[i(y,null,{default:r(()=>[i(g,{cols:"6",class:""},{default:r(()=>[b("h2",ee,m(t.$t("issue.title")),1),b("div",te,m(t.$t("step[0]"))+" "+m(a.step+1)+" "+m(t.$t("step[1]"))+" 2 ",1)]),_:1}),i(g,{cols:"6",class:"text-right pr-0"},{default:r(()=>[a.step===1?(n(),f(C,{key:0,class:"back mr-4",onClick:e[0]||(e[0]=l=>h.back())},{default:r(()=>[_(m(t.$t("button.back")),1)]),_:1})):d("v-if",!0),i(C,{class:"next",loading:a.sending,onClick:e[1]||(e[1]=l=>h.nextStep())},{default:r(()=>[_(m(a.buttonText),1)]),_:1},8,["loading"])]),_:1})]),_:1}),i(Y,{flat:"",class:"pa-0 mt-6 issue-form-wrapper"},{default:r(()=>[i(y,null,{default:r(()=>[i(g,{cols:"12",md:"12",lg:"5",class:"pt-0"},{default:r(()=>[i(j,{modelValue:a.step,"onUpdate:modelValue":e[3]||(e[3]=l=>a.step=l),elevation:"0"},{default:r(()=>[i(B,null,{default:r(()=>[i(k,{step:"0",class:"pa-3"},{default:r(()=>[i(I,{class:"",style:{"max-height":"55vh","overflow-y":"auto"}},{default:r(()=>[i(y,null,{default:r(()=>[a.templateValuesBack.length>0?(n(),f(g,{key:0,cols:"12",class:""},{default:r(()=>[b("p",ae,m(t.$t("createCertModal.front")),1)]),_:1})):d("v-if",!0),(n(!0),V(x,null,F(a.templateValuesFront,(l,c)=>(n(),f(g,{key:l._id,cols:"12",class:"input-field pb-0"},{default:r(()=>[b("label",se,[_(m(l.attr==="IMAGE"&&l.type==="image"?t.$t("issue.labelUpload"):l.attr)+" ",1),l.isMandatory==="true"?(n(),V("span",le," * ")):d("v-if",!0)]),l.inputType==="date"?(n(),f(J,{key:0,modelValue:a.attributesMenu[l.attr],"onUpdate:modelValue":p=>a.attributesMenu[l.attr]=p,"close-on-content-click":!1,"nudge-right":40,transition:"scale-transition","offset-y":"","max-width":"290px","min-width":"290px"},{activator:r(({on:p})=>[i(w,q({color:"#009fb1",readonly:"",value:a.templateValuesFront[c].value},H(p)),null,16,["value"])]),default:r(()=>[i(K,{modelValue:a.templateValuesFront[c].value,"onUpdate:modelValue":p=>a.templateValuesFront[c].value=p,locale:t.$i18n.locale,"no-title":"",onInput:p=>{a.attributesMenu[l.attr]=!1,h.replaceAttributeText(l)}},null,8,["modelValue","onUpdate:modelValue","locale","onInput"])]),_:2},1032,["modelValue","onUpdate:modelValue"])):l.type!=="image"?(n(),V(x,{key:1},[d(" text inputs "),i(w,{modelValue:a.templateValuesFront[c].value,"onUpdate:modelValue":p=>a.templateValuesFront[c].value=p,class:"mt-2",type:l.type,flat:"",solo:"",maxlength:l.maxCharacters,counter:l.maxCharacters,error:a.templateValuesFront[c].error,onInput:p=>{h.clearError(c),h.replaceAttributeText(l)}},null,8,["modelValue","onUpdate:modelValue","type","maxlength","counter","error","onInput"])],2112)):d("v-if",!0),Z(i(C,{text:"",loading:a.imageLoading,class:"advance-btn upload my-5",onClick:p=>h.uploadImage(l,l.indexArray.indexAttr)},{default:r(()=>[_(m(t.$t("issue.buttonUpload")),1)]),_:2},1032,["loading","onClick"]),[[X,l.type==="image"]]),l.type==="image"?(n(),V("input",{key:2,ref_for:!0,ref:"uploadImage",type:"file",style:{display:"none"},accept:"image/*",onChange:p=>h.newImage(p,l)},null,40,re)):d("v-if",!0)]),_:2},1024))),128))]),_:1}),i(y,null,{default:r(()=>[a.templateValuesBack.length>0?(n(),f(g,{key:0,cols:"12",class:""},{default:r(()=>[b("p",ie,m(t.$t("createCertModal.back")),1)]),_:1})):d("v-if",!0)]),_:1}),i(y,null,{default:r(()=>[(n(!0),V(x,null,F(a.templateValuesBack,(l,c)=>(n(),f(g,{key:l._id,cols:"12",class:"input-field pb-0"},{default:r(()=>[b("label",oe,[_(m(l.attr)+" ",1),l.isMandatory==="true"?(n(),V("span",ne," * ")):d("v-if",!0)]),i(w,{modelValue:a.templateValuesBack[c].value,"onUpdate:modelValue":p=>a.templateValuesBack[c].value=p,class:"mt-2",type:l.type,flat:"",solo:"",error:a.templateValuesBack[c].error,onInput:p=>{h.clearError(c),h.replaceAttributeText(l)}},null,8,["modelValue","onUpdate:modelValue","type","error","onInput"])]),_:2},1024))),128))]),_:1})]),_:1})]),_:1}),i(k,{step:"1",class:"pa-3"},{default:r(()=>[i(I,{class:""},{default:r(()=>[i(y,null,{default:r(()=>[i(g,{cols:"12",class:"input-field pb-0",style:{"padding-right":"10px"}},{default:r(()=>[b("label",ue,m(t.$t("issue.emailField")),1),i(w,{modelValue:a.email,"onUpdate:modelValue":e[2]||(e[2]=l=>a.email=l),class:"mt-2",flat:"","persistent-hint":"",rules:a.emailRules,hint:t.$t("issue.emailHint"),"error-messages":a.errorMail,solo:""},null,8,["modelValue","rules","hint","error-messages"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),i(g,{cols:"12",lg:"7",class:"pt-0 template-background"},{default:r(()=>[i(y,null,{default:r(()=>[i(g,{ref:"formTemplate",cols:"12",class:"pt-6"},{default:r(()=>[a.isLoaded&&a.reload?(n(),f(E,{key:0,editable:!1,width:a.issueCredentialWidth,style:{"max-height":"60vh"}},null,8,["width"])):d("v-if",!0),d(" create a div that is behind all the html and is full width and height "),b("div",pe,[a.isLoaded&&a.reload?(n(),f(E,{key:0,editable:!1,width:1420,snapshot:!0})):d("v-if",!0)])]),_:1},512)]),_:1})]),_:1})]),_:1})]),_:1}),a.showSuccessModal?(n(),f(L,{key:0,message:"email",onClose:e[4]||(e[4]=l=>t.$router.go(-1))})):d("v-if",!0)]),_:1})}const _e=S(Q,[["render",ce],["__file","C:/Users/guilh/Documents/EIDCMP/web-app-v3/src/views/ViewTemplate/IssueCredentials.vue"]]);export{_e as default};
//# sourceMappingURL=IssueCredentials-DhoknHdt.js.map
